apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

# Karpenter Configuration
# The tag key used to identify subnets for Karpenter autoscaling
# Default: cortex/karpenter-discovery (to avoid conflicts with standard karpenter.sh/discovery)
# You can override this in your values file with: karpenter.tag-key: "your-custom-key"
karpenter:
  tag-key: "cortex/karpenter-discovery"
  namespace: "karpenter"
  version: "1.0.6"

metadata:
  name: cluster-name
  region: us-east-1
  version: "1.34"
  tags:
    # IMPORTANT: This tag is managed by the setup script
    # The actual tag key used will be from karpenter.tag-key above
    karpenter.sh/discovery: cluster-name
vpc:
  id: "vpc-123456"
  subnets:
    private:
      
    public:
      

iam:
  withOIDC: true
  podIdentityAssociations:
    - namespace: "karpenter"
      serviceAccountName: karpenter
      roleName: ${CLUSTER_NAME}-karpenter
      permissionPolicyARNs:
        - arn:aws:iam::${AWS_ACCOUNT_ID}:policy/KarpenterControllerPolicy-${CLUSTER_NAME}

iamIdentityMappings:
  - arn: "arn:aws:iam::${AWS_ACCOUNT_ID}:role/KarpenterNodeRole-${CLUSTER_NAME}"
    username: system:node:{{EC2PrivateDNSName}}
    groups:
      - system:bootstrappers
      - system:nodes

addons:
  - name: vpc-cni
  - name: coredns
  - name: kube-proxy
  - name: eks-pod-identity-agent # Recommended for simplified IAM
  - name: aws-ebs-csi-driver
    wellKnownPolicies:
      ebsCSIController: true

# You need a small static node group to run the "Controllers" 
# (Karpenter, Nginx, LBC) before Karpenter can scale itself.
managedNodeGroups:
  - name: system-nodes
    instanceType: t3.medium
    amiFamily: AmazonLinux2023
    minSize: 2
    maxSize: 3
    privateNetworking: true