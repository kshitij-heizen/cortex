# =============================================================================
# Milvus Tenant Helm Chart - values.yaml
# =============================================================================
# The org_id is the primary identifier for the tenant/organization.
# All resource names and DNS entries are derived from this value.
# =============================================================================

# Organization/Tenant ID - This is the ROOT variable
# All naming conventions derive from this:
#   - Namespace: milvus-{org_id}
#   - Cluster name: {org_id}
#   - Service: {org_id}-milvus
#   - gRPC host: {org_id}.milvusdb.usecortex.ai
#   - WebUI host: {org_id}-webui.milvusdb.usecortex.ai
#   - Attu host: {org_id}-attu.milvusdb.usecortex.ai
org_id: cortexai

# -----------------------------------------------------------------------------
# Namespace Configuration
# -----------------------------------------------------------------------------
namespace:
  create: true

# -----------------------------------------------------------------------------
# Storage Class Configuration
# -----------------------------------------------------------------------------
storageClass:
  create: true
  name: milvus-storage  # Used if create is false
  provisioner: ebs.csi.aws.com
  parameters:
    type: gp3
    iops: 3000
    throughput: 125
    fsType: ext4
    encrypted: true
  allowVolumeExpansion: true
  volumeBindingMode: WaitForFirstConsumer
  reclaimPolicy: Retain

# -----------------------------------------------------------------------------
# Node Selector and Tolerations (applied to all components)
# -----------------------------------------------------------------------------
nodeSelector:
  role: memory-db-large-scalable

tolerations:
  - key: workload
    operator: Equal
    value: database-large-scalable
    effect: NoSchedule

# -----------------------------------------------------------------------------
# Milvus Cluster Configuration
# -----------------------------------------------------------------------------
milvus:
  mode: cluster
  
  config:
    logLevel: info
    authEnabled: true
    maxVectorFieldNum: 10  # Max allowed in Milvus v2.6.0 is 10 (was 20, caused panic)
  
  components:
    proxy:
      replicas: 2
      serviceType: ClusterIP
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "2"
          memory: "4Gi"
    
    queryNode:
      replicas: 2
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          cpu: "4"
          memory: "10Gi"
    
    dataNode:
      replicas: 2
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "2"
          memory: "4Gi"
    
    indexNode:
      replicas: 1
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "4"
          memory: "8Gi"
    
    mixCoord:
      replicas: 1
      resources:
        requests:
          cpu: "500m"
          memory: "512Mi"
        limits:
          cpu: "2"
          memory: "2Gi"

  dependencies:
    etcd:
      deletionPolicy: Delete
      pvcDeletion: false
      replicaCount: 3
      storageSize: 10Gi
      resources:
        requests:
          cpu: "100m"
          memory: "512Mi"
        limits:
          cpu: "1"
          memory: "2Gi"
    
    minio:
      deletionPolicy: Delete
      pvcDeletion: false
      mode: distributed
      replicas: 4
      storageSize: 100Gi
      resources:
        requests:
          cpu: "100m"
          memory: "512Mi"
        limits:
          cpu: "2"
          memory: "4Gi"
    
    msgStream:
      type: pulsar
    
    pulsar:
      deletionPolicy: Delete
      pvcDeletion: false
      proxy:
        replicas: 1
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
      bookkeeper:
        replicas: 2
        journalSize: 20Gi
        ledgersSize: 50Gi
        resources:
          requests:
            cpu: "100m"
            memory: "512Mi"
      zookeeper:
        replicas: 1
        storageSize: 10Gi
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
      broker:
        replicas: 1
        resources:
          requests:
            cpu: "100m"
            memory: "512Mi"

# -----------------------------------------------------------------------------
# Ingress Configuration
# -----------------------------------------------------------------------------
ingress:
  className: nginx-inc
  domain: milvusdb.usecortex.ai
  
  # Optional: override the auto-generated TLS secret name
  # If not set, uses: milvus-wildcard-tls-{org_id}
  tlsSecretName: ""
  
  grpc:
    enabled: true
    proxyConnectTimeout: "60s"
    proxyReadTimeout: "600s"
    proxySendTimeout: "600s"
    annotations: {}
  
  webui:
    enabled: true
    proxyConnectTimeout: "60s"
    proxyReadTimeout: "300s"
    proxySendTimeout: "300s"
    clientMaxBodySize: "100m"
    annotations: {}
  
  attu:
    enabled: true
    proxyConnectTimeout: "60s"
    proxyReadTimeout: "300s"
    proxySendTimeout: "300s"
    clientMaxBodySize: "100m"
    annotations: {}

# -----------------------------------------------------------------------------
# Attu Admin UI Configuration
# -----------------------------------------------------------------------------
attu:
  enabled: true
  replicas: 1
  image:
    repository: zilliz/attu
    tag: v2.4
  logLevel: info
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# -----------------------------------------------------------------------------
# Certificate Configuration (cert-manager)
# -----------------------------------------------------------------------------
certificate:
  create: true  # Set to true to create wildcard certificate
  issuerRef:
    name: letsencrypt-dns01-milvus
    kind: ClusterIssuer
  duration: 2160h    # 90 days
  renewBefore: 360h  # 15 days before expiry

# -----------------------------------------------------------------------------
# ClusterIssuer Configuration (cert-manager)
# -----------------------------------------------------------------------------
clusterIssuer:
  create: false  # Set to true to create ClusterIssuer
  name: letsencrypt-dns01-milvus
  email: cloud@usecortex.ai
  server: https://acme-v02.api.letsencrypt.org/directory
  privateKeySecretRef: letsencrypt-dns01-milvus-key
  cloudflare:
    apiTokenSecretName: cloudflare-api-token-milvus
    apiTokenKey: api-token

# -----------------------------------------------------------------------------
# Monitoring Configuration (Prometheus ServiceMonitor)
# -----------------------------------------------------------------------------
monitoring:
  enabled: true
  releaseLabel: monitoring
  interval: 30s
