---
# Source: milvus-tenant/templates/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
---
# Source: milvus-tenant/templates/storage-class.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: milvus-storage-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  fsType: ext4
  encrypted: "true"
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Retain
---
# Source: milvus-tenant/templates/attu.yaml
apiVersion: v1
kind: Service
metadata:
  name: trial-attu
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
    app: attu
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
      protocol: TCP
      name: http
  selector:
    app: attu
    org_id: trial
---
# Source: milvus-tenant/templates/attu.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: trial-attu
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
    app: attu
spec:
  replicas: 1
  selector:
    matchLabels:
      app: attu
      org_id: trial
  template:
    metadata:
      labels:
        app: attu
        org_id: trial
    spec:
      nodeSelector:
        role: memory-db-large-scalable
      tolerations:
        - effect: NoSchedule
          key: workload
          operator: Equal
          value: database-large-scalable
      containers:
        - name: attu
          image: zilliz/attu:v2.4
          ports:
            - containerPort: 3000
          env:
            - name: MILVUS_URL
              value: "trial-milvus.milvus-trial.svc.cluster.local:19530"
            - name: ATTU_LOG_LEVEL
              value: "info"
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 256Mi
---
# Source: milvus-tenant/templates/attu.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: trial-attu-ingress
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
  annotations:
    nginx.org/proxy-connect-timeout: "60s"
    nginx.org/proxy-read-timeout: "300s"
    nginx.org/proxy-send-timeout: "300s"
    nginx.org/client-max-body-size: "100m"
spec:
  ingressClassName: nginx-inc
  tls:
    - hosts:
        - trial-attu.milvusdb.usecortex.ai
      secretName: milvus-wildcard-tls-trial
  rules:
    - host: trial-attu.milvusdb.usecortex.ai
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: trial-attu
                port:
                  number: 3000
---
# Source: milvus-tenant/templates/ingress-grpc.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: trial-milvus-grpc-ingress
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
  annotations:
    nginx.org/http2: "true"
    nginx.org/grpc-services: "trial-milvus"
    nginx.org/proxy-connect-timeout: "60s"
    nginx.org/proxy-read-timeout: "600s"
    nginx.org/proxy-send-timeout: "600s"
spec:
  ingressClassName: nginx-inc
  tls:
    - hosts:
        - trial.milvusdb.usecortex.ai
      secretName: milvus-wildcard-tls-trial
  rules:
    - host: trial.milvusdb.usecortex.ai
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: trial-milvus
                port:
                  number: 19530
---
# Source: milvus-tenant/templates/ingress-webui.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: trial-milvus-webui-ingress
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
  annotations:
    nginx.org/proxy-connect-timeout: "60s"
    nginx.org/proxy-read-timeout: "300s"
    nginx.org/proxy-send-timeout: "300s"
    nginx.org/client-max-body-size: "100m"
spec:
  ingressClassName: nginx-inc
  tls:
    - hosts:
        - trial-webui.milvusdb.usecortex.ai
      secretName: milvus-wildcard-tls-trial
  rules:
    - host: trial-webui.milvusdb.usecortex.ai
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: trial-milvus
                port:
                  number: 9091
---
# Source: milvus-tenant/templates/certificate.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: trial-milvus-wildcard-cert
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
spec:
  secretName: milvus-wildcard-tls-trial
  issuerRef:
    name: letsencrypt-dns01-milvus
    kind: ClusterIssuer
  commonName: "*.milvusdb.usecortex.ai"
  dnsNames:
    - "*.milvusdb.usecortex.ai"
    - "milvusdb.usecortex.ai"
  duration: 2160h
  renewBefore: 360h
---
# Source: milvus-tenant/templates/milvus-cluster.yaml
apiVersion: milvus.io/v1beta1
kind: Milvus
metadata:
  name: trial
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
spec:
  mode: cluster
  
  config:
    milvus:
      log:
        level: info
      common:
        security:
          authorizationEnabled: true
  
  components:
    disableMetric: false
    nodeSelector:
      role: memory-db-large-scalable
    tolerations:
      - effect: NoSchedule
        key: workload
        operator: Equal
        value: database-large-scalable
    
    proxy:
      replicas: 2
      resources:
        limits:
          cpu: "2"
          memory: 4Gi
        requests:
          cpu: 500m
          memory: 1Gi
      serviceType: ClusterIP
    
    queryNode:
      replicas: 2
      resources:
        limits:
          cpu: "4"
          memory: 10Gi
        requests:
          cpu: 500m
          memory: 2Gi
    
    dataNode:
      replicas: 2
      resources:
        limits:
          cpu: "2"
          memory: 4Gi
        requests:
          cpu: 500m
          memory: 1Gi
    
    indexNode:
      replicas: 1
      resources:
        limits:
          cpu: "4"
          memory: 8Gi
        requests:
          cpu: 500m
          memory: 1Gi
    
    mixCoord:
      replicas: 1
      resources:
        limits:
          cpu: "2"
          memory: 2Gi
        requests:
          cpu: 500m
          memory: 512Mi

  dependencies:
    etcd:
      inCluster:
        deletionPolicy: Delete
        pvcDeletion: false
        values:
          replicaCount: 3
          nodeSelector:
            role: memory-db-large-scalable
          tolerations:
            - effect: NoSchedule
              key: workload
              operator: Equal
              value: database-large-scalable
          persistence:
            enabled: true
            storageClass: milvus-storage-trial
            size: 10Gi
          resources:
            limits:
              cpu: "1"
              memory: 2Gi
            requests:
              cpu: 100m
              memory: 512Mi
    
    storage:
      inCluster:
        deletionPolicy: Delete
        pvcDeletion: false
        values:
          mode: distributed
          replicas: 4
          nodeSelector:
            role: memory-db-large-scalable
          tolerations:
            - effect: NoSchedule
              key: workload
              operator: Equal
              value: database-large-scalable
          persistence:
            enabled: true
            storageClass: milvus-storage-trial
            size: 100Gi
          resources:
            limits:
              cpu: "2"
              memory: 4Gi
            requests:
              cpu: 100m
              memory: 512Mi
    
    msgStreamType: pulsar
    pulsar:
      inCluster:
        deletionPolicy: Delete
        pvcDeletion: false
        values:
          nodeSelector:
            role: memory-db-large-scalable
          tolerations:
            - effect: NoSchedule
              key: workload
              operator: Equal
              value: database-large-scalable
          components:
            autorecovery: false
          proxy:
            replicaCount: 1
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
          bookkeeper:
            replicaCount: 2
            resources:
              requests:
                cpu: 100m
                memory: 512Mi
            volumes:
              journal:
                size: 20Gi
                storageClassName: milvus-storage-trial
              ledgers:
                size: 50Gi
                storageClassName: milvus-storage-trial
          zookeeper:
            replicaCount: 1
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
            volumes:
              data:
                size: 10Gi
                storageClassName: milvus-storage-trial
          broker:
            replicaCount: 1
            resources:
              requests:
                cpu: 100m
                memory: 512Mi
---
# Source: milvus-tenant/templates/service-monitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: trial-milvus-monitor
  namespace: milvus-trial
  labels:
    helm.sh/chart: milvus-tenant-0.1.0
    app.kubernetes.io/name: milvus
    app.kubernetes.io/instance: trial
    app.kubernetes.io/version: "2.4.0"
    app.kubernetes.io/managed-by: Helm
    org_id: trial
    release: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: trial
      app.kubernetes.io/name: milvus
      milvus.io/service: "true"
  namespaceSelector:
    matchNames:
      - milvus-trial
  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      relabelings:
        - action: replace
          replacement: trial
          targetLabel: org_id
        - action: replace
          replacement: trial
          targetLabel: organization
